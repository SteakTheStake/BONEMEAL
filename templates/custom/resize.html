<!DOCTYPE html>
<html lang="en">
<head>
    <!-- ... (Bootstrap and custom CSS links) ... -->
    <title>BONEMEAL</title>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css" rel="stylesheet">
    <link href="{{ url_for('static', filename='/css/style.css') }}" rel="stylesheet">
</head>
<body>
<div class="rainbow-blur">
    <div class='rainbow'></div>
    <div class='rainbow'></div>
    <div class='rainbow'></div>
    <div class='rainbow'></div>
    <div class='rainbow'></div>
    <div class='rainbow'></div>
    <div class='rainbow'></div>
    <div class='rainbow'></div>
    <div class='rainbow'></div>
    <div class='rainbow'></div>
    <div class='rainbow'></div>
    <div class='rainbow'></div>
    <div class='rainbow'></div>
    <div class='rainbow'></div>
    <div class='rainbow'></div>
    <div class='rainbow'></div>
    <div class='rainbow'></div>
    <div class='rainbow'></div>
    <div class='rainbow'></div>
    <div class='rainbow'></div>
    <div class='h'></div>
    <div class='v'></div>
</div>
<main class="container main">
    <h1>Image Resizer</h1>
    {% if error %}
        <p style="color: red;">{{ error }}</p>
    {% endif %}
    <form action="/resize" method="post" enctype="multipart/form-data">
        <label for="files">Select images:</label>
        <input type="file" id="files" name="files" multiple>
        <br>
        <label for="percentage">Resize Percentage (1-100):</label>
        <input type="number" id="percentage" name="percentage" min="1" max="100">
        <br>
        <input type="submit" value="Upload and Resize">
    </form>
</main>
<!-- JavaScript for interactive elements -->
<script src="https://code.jquery.com/jquery-3.5.1.slim.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.0.2/dist/umd/popper.min.js"></script>
<script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>
<script src="{{ url_for('static', filename='/js/script.js') }}"></script>
<script src="{{ url_for('static', filename='/js/sound.js') }}"></script>
<script src="{{ url_for('static', filename='/js/uploaded-files.js') }}"></script>
<script type="module" src="{{ url_for('static', filename='/pkg/bonemeal.js') }}"></script>
<script type="application/wasm" src="{{ url_for('static', filename='/pkg/bonemeal_bg.wasm') }}"></script>
<script src="{{ url_for('static', filename='/js/wasm-parser.js') }}"></script>
<script src="https://unpkg.com/dropzone@6.0.0-beta.1/dist/dropzone-min.js"></script>
<script>
    Dropzone.options.fileUpload = {
        paramName: "file",
        maxFilesize: 15, // MB
        acceptedFiles: 'image/*', // Accept only image files
        accept: function(file, done) {
            var extension = file.name.split('.').pop().toLowerCase();
            var allowedExtensions = ['jpg', 'jpeg', 'png', 'gif', 'bmp', 'tiff'];

            if (!allowedExtensions.includes(extension)) {
                done("Only image files are allowed.");
            } else {
                done();
            }
        }
    };
</script>
<script type="module">
    const filesJson = '{{ files | tojson | safe }}' || "[]";
    let files = JSON.parse(filesJson);
    const wasmModuleUrl = '/run-resize';

    async function loadWasmModule() {
        try {
            const response = await fetch(wasmModuleUrl);
            const bytes = await response.arrayBuffer();
            const results = await WebAssembly.instantiate(bytes, {});
            window.wasmModule = results.instance.exports;
        } catch (error) {
            console.error("Failed to load WASM module:", error);
        }
    }

    async function processFiles(percentage) {
        if (!window.wasmModule) {
            console.error("WASM module is not loaded yet.");
            return;
        }

        for (let file of files) {
            try {
                const response = await fetch(file);
                const buffer = await response.arrayBuffer();
                const uint8Buffer = new Uint8Array(buffer);

                const ptr = window.wasmModule.__wbindgen_malloc(uint8Buffer.length);
                const memory = new Uint8Array(window.wasmModule.memory.buffer, ptr, uint8Buffer.length);
                memory.set(uint8Buffer);

                // Assuming resize_image returns a pointer to the resized image data and its length
                const resizedImagePtr = window.wasmModule.resize_image(ptr, uint8Buffer.length, percentage);

                // Retrieve the length of the resized image from your WASM module
                // This depends on how your WASM module is structured
                const resizedImageLength = window.wasmModule.get_resized_image_length(resizedImagePtr);

                // Extract the resized image data from the WASM memory
                const resizedImage = new Uint8Array(window.wasmModule.memory.buffer, resizedImagePtr, resizedImageLength);

                // Handle the resized image data
                // Example: converting the Uint8Array to a Blob and creating an Object URL
                const blob = new Blob([resizedImage], { type: "image/jpeg" }); // Adjust the MIME type accordingly
                const imageUrl = URL.createObjectURL(blob);

                // You can now use `imageUrl` for img src, download, etc.
                // Example: Display the image
                const img = document.createElement("img");
                img.src = imageUrl;
                document.body.appendChild(img);

                // Free the memory allocated for the resized image in WASM
                window.wasmModule.__wbindgen_free(resizedImagePtr, resizedImageLength);

                window.wasmModule.__wbindgen_free(ptr, uint8Buffer.length);
                // Also free any other allocated memory if necessary

            } catch (error) {
                console.error("Error processing file:", file, error);
            }
        }
    }

    window.onload = loadWasmModule;
</script>
</body>
</html>
